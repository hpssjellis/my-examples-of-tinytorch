# Start with a standard Python base image (provides Python and pip)
FROM python:3.9-slim

# Set environment variables
ENV PYTHONUNBUFFERED 1
ENV TITO_ROOT /TinyTorch
ENV APP_ROOT /var/www/html

# ----------------------------------------------------------------------
# 1. Install System Dependencies & Node.js
# ----------------------------------------------------------------------

# Install core build dependencies, git, and libraries needed for numpy/torch/matplotlib
# Also install Node.js (required for the TFJS track in the course)
RUN apt-get update && apt-get install -y \
    # Core tools
    git \
    curl \
    gnupg \
    ca-certificates \
    # Build Dependencies for NumPy/PyTorch/Matplotlib
    build-essential \
    libblas-dev \
    liblapack-dev \
    python3-dev \
    libjpeg-dev \
    zlib1g-dev \
    # Node.js dependencies
    && \
    # ------------------ Node.js Installation ------------------
    # 1. Add NodeSource GPG key and repository
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list > /dev/null && \
    # 2. Update and install Node.js (includes npm)
    apt-get update && \
    apt-get install -y nodejs \
    --no-install-recommends && \
    # 3. Cleanup
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*


# ----------------------------------------------------------------------
# 2. Clone and Setup TinyTorch
# ----------------------------------------------------------------------

# Set the working directory for the TinyTorch repository
WORKDIR $TITO_ROOT

# Clone the TinyTorch repository
RUN git clone https://github.com/mlsysbook/TinyTorch.git .

# Upgrade pip (standard practice)
RUN python -m pip install --no-cache-dir --upgrade pip

# Install Explicit Core Dependencies
# NOTE: Using the requirements.txt structure (flask, gunicorn, etc.)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Manually install PyTorch (CPU-only is safer for Docker deployments)
# NOTE: The provided setup uses 'PyTorch', but we specify the CPU version for stability.
RUN pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# Install NBGrader (Required for full course/instructor functionality)
RUN pip install --no-cache-dir nbgrader

# Configure TinyTorch in Development (Editable) Mode, enabling the 'tito' CLI.
RUN pip install -e .

# ----------------------------------------------------------------------
# 3. Application Setup and Startup
# ----------------------------------------------------------------------

# Set the working directory for the Flask application (app.py)
WORKDIR $APP_ROOT

# Copy the Flask application and related files to the web root
COPY app.py $APP_ROOT/
# Copy the requirements.txt again to the APP_ROOT to align with the course content if needed, though installed above
# COPY requirements.txt $APP_ROOT/

# Expose the standard HTTP port
EXPOSE 80

# CRITICAL: Set the command to run the Flask application using Gunicorn.
# This serves the web application on container startup.
# We are binding to 0.0.0.0 on port 80, and running the instance 'myApp' from 'app.py'.
CMD ["gunicorn", "--bind", "0.0.0.0:80", "app:myApp"]
